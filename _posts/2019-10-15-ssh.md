---
layout: post
title: "SSH 跳板机"
tagline: "不同局域网下的机器通过 SSH 直连..."
#categories: 
#author: ""
#meta: ""
---
组里的服务器没有连接**外网**，必须先通过 **SSH** 登录**学院服务器的管理节点**，利用它作为**跳板机**，再次**嵌套** SSH 登录，但这样子用起来很麻烦，而且相应的 **VS Code** 的 **Remote-SSH** 插件就不好配置了。

### **各机器之间的关系**

我们首先要搞清楚各机器之间的关系：
* 学院服务器的**管理节点** (IP: 10.30.13.121) 是与校园网接通的。
* **本机**在连接校园网或者挂学校 VPN 时可以 SSH 登录该管理节点。
* 机房有 **3 台机器** (IP: 192.168.1.22、192.168.1.33 和 192.168.1.44) 通过网线连接学院服务器的**交换机**。
<center>
<div class="mermaid">
graph LR
A(本机)-->C((学院服务器的管理节点<br>&ensp;&ensp;&ensp;10.30.13.121))
C-->D(192.168.1.22)
C-->E(192.168.1.33)
C-->F(192.168.1.44)
</div>
</center>
<center>▲ 各机器之间的关系示意图 ( 流程图需代码转换后渲染，可能加载较慢 )</center>

根据上图可知：我们将以**学院管理节点**为**跳板机**连接**本机**和另外 **3 台机器**。

### **建立与跳板机的互信 (optional)**

建立本机与跳板机 (IP: 10.30.13.121) 的互信:

``` bash
ssh-copy-id -p 22 wwang@10.30.13.121
```

### **通过 ProxyCommand 实现 SSH 直连**

修改本机**根目录 (~)** 下 .ssh 文件夹里的 **config 文件**：

``` bash
ServerAliveInterval 60

Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_rsa
  
Host tongjiphy
  HostName 10.30.13.121
  User wwang

Host tesla
	HostName 192.168.1.33
	User wwang
	ProxyCommand ssh -q -W %h:%p tongjiphy

Host geforce1
	HostName 192.168.1.22
	User wwang
	ProxyCommand ssh -q -W %h:%p tongjiphy

Host geforce2
	HostName 192.168.1.44
	User wwang
	ProxyCommand ssh -q -W %h:%p tongjiphy

```

可以看到，我以**学院管理节点** tongjiphy (IP: 10.30.13.121) 作为**跳板机**，利用 `ProxyCommand` 来实现直接**不同局域网**机器的 SSH 直连。

**注**：在 Windows 下使用 `ProxyCommand` 后面必须加上 `ssh` 的完整路径，即：
```
ProxyCommand C:\Windows\System32\OpenSSH\ssh.exe -q -W %h:%p tongjiphy
```

### **结语**
完成上述配置后就可以直接使用 `ssh tesla` 、 `ssh geforce1` 或者 `ssh geforce2` 直接登录了，同样也可以使用 **VS Code** 的 **Remote-SSH** 插件远程编写和调试运行程序了！🎉 🎉 🎉 

&ensp;

[Go to the Home Page]({{ site.url }}{{ site.baseurl }})